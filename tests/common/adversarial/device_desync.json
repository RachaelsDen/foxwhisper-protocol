[
  {
    "scenario_id": "dr_sync_gap_recovers",
    "tags": ["dr-divergence", "recovery"],
    "devices": [
      {"device_id": "d1", "dr_version": 10, "clock_ms": 0, "state_hash": "h1"},
      {"device_id": "d2", "dr_version": 10, "clock_ms": 0, "state_hash": "h1"},
      {"device_id": "d3", "dr_version": 10, "clock_ms": 0, "state_hash": "h1"}
    ],
    "timeline": [
      {"t": 0, "event": "send", "from": "d1", "to": ["d2", "d3"], "msg_id": "m1", "dr_version": 11, "state_hash": "h1a"},
      {"t": 50, "event": "recv", "device": "d2", "msg_id": "m1", "apply_dr_version": 11, "state_hash": "h1a"},
      {"t": 120, "event": "drop", "msg_id": "m1", "targets": ["d3"], "reason": "partial_delivery"},
      {"t": 200, "event": "resync", "device": "d3", "target_dr_version": 11, "state_hash": "h1a"}
    ],
    "expectations": {
      "detected": true,
      "max_detection_ms": 120,
      "max_recovery_ms": 250,
      "healing_required": true,
      "residual_divergence_allowed": false,
      "max_dr_version_delta": 1,
      "max_clock_skew_ms": 200,
      "allow_message_loss_rate": 0.6,
      "allow_out_of_order_rate": 0.1,
      "expected_error_categories": ["MESSAGE_LOSS", "DIVERGENCE_DETECTED"],
      "max_rollback_events": 0
    }
  },
  {
    "scenario_id": "clock_skew_and_stale_backup",
    "tags": ["clock-skew", "backup-restore", "stale-dr"],
    "devices": [
      {"device_id": "primary", "dr_version": 21, "clock_ms": 0, "state_hash": "p0"},
      {"device_id": "secondary", "dr_version": 21, "clock_ms": 0, "state_hash": "s0"},
      {"device_id": "tablet", "dr_version": 21, "clock_ms": 0, "state_hash": "t0"}
    ],
    "timeline": [
      {"t": 0, "event": "clock_skew", "device": "tablet", "delta_ms": 4500},
      {"t": 20, "event": "send", "from": "primary", "to": ["secondary", "tablet"], "msg_id": "m2", "dr_version": 22, "state_hash": "p1"},
      {"t": 70, "event": "recv", "device": "secondary", "msg_id": "m2", "apply_dr_version": 22, "state_hash": "s1"},
      {"t": 90, "event": "backup_restore", "device": "tablet", "dr_version": 20, "state_hash": "t-stale", "source": "stale-backup"},
      {"t": 120, "event": "resync", "device": "tablet", "target_dr_version": 22, "state_hash": "t1"}
    ],
    "expectations": {
      "detected": true,
      "max_detection_ms": 90,
      "max_recovery_ms": 200,
      "healing_required": true,
      "residual_divergence_allowed": false,
      "max_dr_version_delta": 2,
      "max_clock_skew_ms": 5000,
      "allow_message_loss_rate": 0.6,
      "allow_out_of_order_rate": 0.1,
      "expected_error_categories": ["DIVERGENCE_DETECTED", "ROLLBACK_APPLIED", "MESSAGE_LOSS"],
      "max_rollback_events": 2
    }
  },
  {
    "scenario_id": "replay_vs_stale_dr",
    "tags": ["replay", "stale-dr", "partial-delivery"],
    "devices": [
      {"device_id": "a", "dr_version": 30, "clock_ms": 0, "state_hash": "ha"},
      {"device_id": "b", "dr_version": 30, "clock_ms": 0, "state_hash": "hb"},
      {"device_id": "c", "dr_version": 30, "clock_ms": 0, "state_hash": "hc"}
    ],
    "timeline": [
      {"t": 0, "event": "send", "from": "a", "to": ["b", "c"], "msg_id": "m3", "dr_version": 31, "state_hash": "ha1"},
      {"t": 40, "event": "recv", "device": "b", "msg_id": "m3", "apply_dr_version": 31, "state_hash": "hb1"},
      {"t": 60, "event": "drop", "msg_id": "m3", "targets": ["c"], "reason": "replay-window-drop"},
      {"t": 90, "event": "replay", "from": "a", "to": ["c"], "msg_id": "m3", "dr_version": 31},
      {"t": 120, "event": "backup_restore", "device": "c", "dr_version": 29, "state_hash": "hc-stale", "source": "stale-dr"},
      {"t": 150, "event": "resync", "device": "c", "target_dr_version": 31, "state_hash": "hc1"}
    ],
    "expectations": {
      "detected": true,
      "max_detection_ms": 120,
      "max_recovery_ms": 250,
      "healing_required": true,
      "residual_divergence_allowed": false,
      "max_dr_version_delta": 2,
      "max_clock_skew_ms": 1000,
      "allow_message_loss_rate": 0.8,
      "allow_out_of_order_rate": 0.2,
      "expected_error_categories": ["MESSAGE_LOSS", "DIVERGENCE_DETECTED", "ROLLBACK_APPLIED"],
      "max_rollback_events": 2
    }
  }
]
