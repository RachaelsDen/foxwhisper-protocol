# FoxWhisper v0.9 - Canonical CBOR Encoding Examples

*Conformance Test Suite - Section 4.1.1*

## Overview

This document provides canonical CBOR encoding examples for all FoxWhisper v0.8.1 message types. These examples serve as test vectors for implementation validation and ensure cross-platform compatibility.

## CBOR Canonicalization Rules

FoxWhisper uses canonical CBOR encoding as defined in RFC 8949 with the following constraints:

1. **Integer Encoding**: Use the smallest possible encoding (major type 0/1)
2. **Map Key Ordering**: Keys sorted by length, then lexicographically
3. **Array Encoding**: Fixed-length arrays preferred over indefinite-length
4. **String Encoding**: UTF-8 strings, prefer definite-length
5. **Tag Usage**: Semantic tags for cryptographic material only
6. **Floating Point**: Prefer integer encoding when possible

## Message Type Registry

| Type ID | Name | CBOR Tag | Description |
|---------|------|----------|-------------|
| 0x01 | HANDSHAKE_INIT | 0xD1 | Post-quantum handshake initiation |
| 0x02 | HANDSHAKE_RESPONSE | 0xD2 | Post-quantum handshake response |
| 0x03 | HANDSHAKE_COMPLETE | 0xD3 | Handshake completion confirmation |
| 0x04 | DR_BACKUP | 0xD4 | Device Record backup |
| 0x05 | DR_RESTORE | 0xD5 | Device Record restoration |
| 0x06 | DR_RESET | 0xD6 | Device Record reset |
| 0x07 | GROUP_CREATE | 0xD7 | Group creation |
| 0x08 | GROUP_JOIN | 0xD8 | Group member join |
| 0x09 | GROUP_LEAVE | 0xD9 | Group member leave |
| 0x0A | GROUP_KEY_DISTRIBUTION | 0xDA | Sender key distribution |
| 0x0B | EPOCH_AUTHENTICITY_RECORD | 0xDB | Epoch authenticity record |
| 0x0C | MEDIA_KEY_DISTRIBUTION | 0xDC | Media stream key distribution |
| 0x0D | MEDIA_FRAME | 0xDD | Encrypted media frame |

---

## 1. Handshake Messages

### 1.1 HANDSHAKE_INIT (Type 0x01)

**Message Structure**:
```json
{
  "type": "HANDSHAKE_INIT",
  "version": 1,
  "client_id": "base64url-encoded-32-byte-client-id",
  "x25519_public_key": "base64url-encoded-32-byte-x25519-pubkey",
  "kyber_public_key": "base64url-encoded-1568-byte-kyber-pubkey",
  "timestamp": 1701763200000,
  "nonce": "base64url-encoded-16-byte-random-nonce"
}
```

**Canonical CBOR Hex Representation**:
```
D1                                           # Tag(0xD1) - HANDSHAKE_INIT
A7                                           # Map(7)
   64                                        # Text(4) "type"
   6D48414E445348414B455F494E4954           # "HANDSHAKE_INIT"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "client_id"
   78 20                                     # Byte(32)
      4142434445464748494A4B4C4D4E4F505152535455565758595A6162636465666768
   6F                                        # Text(15) "x25519_public_key"
   78 20                                     # Byte(32)
      0102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F20
   6E                                        # Text(14) "kyber_public_key"
   78 620                                    # Byte(1568)
      [1568 bytes of Kyber public key data]
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1000                     # Unsigned(1701763200000)
   64                                        # Text(4) "nonce"
   78 10                                     # Byte(16)
      00112233445566778899AABBCCDDEEFF
```

**Base64 Encoded CBOR**:
```
0Wp7dHlwZUhhbmRzaGFrZV9pbml0dmVyc2lvbgFjbGllbnRfaWQeIEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2g
eIGZveDI1NTE5X3B1YmxpY19rZXl4IAECBBERUYhI0JTVFpcXl5eX2FhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eg==
```

### 1.2 HANDSHAKE_RESPONSE (Type 0x02)

**Message Structure**:
```json
{
  "type": "HANDSHAKE_RESPONSE",
  "version": 1,
  "server_id": "base64url-encoded-32-byte-server-id",
  "x25519_public_key": "base64url-encoded-32-byte-x25519-pubkey",
  "kyber_ciphertext": "base64url-encoded-1568-byte-kyber-ciphertext",
  "timestamp": 1701763201000,
  "nonce": "base64url-encoded-16-byte-random-nonce"
}
```

**Canonical CBOR Hex Representation**:
```
D2                                           # Tag(0xD2) - HANDSHAKE_RESPONSE
A7                                           # Map(7)
   64                                        # Text(4) "type"
   7048414E445348414B455F524553504F4E5345   # "HANDSHAKE_RESPONSE"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "server_id"
   78 20                                     # Byte(32)
      5152535455565758595A6162636465666768696A6B6C6D6E6F7071727374757677
   6F                                        # Text(15) "x25519_public_key"
   78 20                                     # Byte(32)
      2122232425262728292A2B2C2D2E2F303132333435363738393A3B3C3D3E3F40
   6F                                        # Text(15) "kyber_ciphertext"
   78 620                                    # Byte(1568)
      [1568 bytes of Kyber ciphertext data]
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1064                     # Unsigned(1701763201000)
   64                                        # Text(4) "nonce"
   78 10                                     # Byte(16)
      112233445566778899AABBCCDDEEFF00
```

### 1.3 HANDSHAKE_COMPLETE (Type 0x03)

**Message Structure**:
```json
{
  "type": "HANDSHAKE_COMPLETE",
  "version": 1,
  "session_id": "base64url-encoded-32-byte-session-id",
  "handshake_hash": "base64url-encoded-32-byte-handshake-hash",
  "timestamp": 1701763202000
}
```

**Canonical CBOR Hex Representation**:
```
D3                                           # Tag(0xD3) - HANDSHAKE_COMPLETE
A4                                           # Map(4)
   64                                        # Text(4) "type"
   7248414E445348414B455F434F4D504C455445   # "HANDSHAKE_COMPLETE"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   6A                                        # Text(10) "session_id"
   78 20                                     # Byte(32)
      6162636465666768696A6B6C6D6E6F707172737475767778797A3031323334353637
   6D                                        # Text(13) "handshake_hash"
   78 20                                     # Byte(32)
      38394142434445464748494A4B4C4D4E4F505152535455565758595A6162636465
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E10C8                     # Unsigned(1701763202000)
```

---

## 2. Device Record (DR) Messages

### 2.1 DR_BACKUP (Type 0x04)

**Message Structure**:
```json
{
  "type": "DR_BACKUP",
  "version": 1,
  "device_id": "base64url-encoded-32-byte-device-id",
  "dr_data": "base64url-encoded-encrypted-dr-data",
  "backup_version": 1,
  "timestamp": 1701763203000
}
```

**Canonical CBOR Hex Representation**:
```
D4                                           # Tag(0xD4) - DR_BACKUP
A5                                           # Map(5)
   64                                        # Text(4) "type"
   5944525F4241434B5550                      # "DR_BACKUP"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "device_id"
   78 20                                     # Byte(32)
      7172737475767778797A7B7C7D7E7F808182838485868788898A8B8C8D8E8F90
   67                                        # Text(7) "dr_data"
   78 80                                     # Byte(128)
      [128 bytes of encrypted DR data]
   6E                                        # Text(14) "backup_version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E112C                     # Unsigned(1701763203000)
```

### 2.2 DR_RESTORE (Type 0x05)

**Message Structure**:
```json
{
  "type": "DR_RESTORE",
  "version": 1,
  "device_id": "base64url-encoded-32-byte-device-id",
  "restore_token": "base64url-encoded-32-byte-restore-token",
  "timestamp": 1701763204000
}
```

**Canonical CBOR Hex Representation**:
```
D5                                           # Tag(0xD5) - DR_RESTORE
A4                                           # Map(4)
   64                                        # Text(4) "type"
   5A44525F524553544F5245                  # "DR_RESTORE"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "device_id"
   78 20                                     # Byte(32)
      9192939495969798999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8A9AAABACADAEAFB0
   6D                                        # Text(13) "restore_token"
   78 20                                     # Byte(32)
      B1B2B3B4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCCCDCECFD0
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1190                     # Unsigned(1701763204000)
```

### 2.3 DR_RESET (Type 0x06)

**Message Structure**:
```json
{
  "type": "DR_RESET",
  "version": 1,
  "device_id": "base64url-encoded-32-byte-device-id",
  "reset_reason": "user_initiated",
  "timestamp": 1701763205000
}
```

**Canonical CBOR Hex Representation**:
```
D6                                           # Tag(0xD6) - DR_RESET
A4                                           # Map(4)
   64                                        # Text(4) "type"
   5844525F5245534554                      # "DR_RESET"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   69                                        # Text(9) "device_id"
   78 20                                     # Byte(32)
      D1D2D3D4D5D6D7D8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7E8E9EAEBECEDEEEFF0F1
   6C                                        # Text(12) "reset_reason"
   6E757365725F696E69746961746564           # "user_initiated"
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E11F4                     # Unsigned(1701763205000)
```

---

## 3. Group Management Messages

### 3.1 GROUP_CREATE (Type 0x07)

**Message Structure**:
```json
{
  "type": "GROUP_CREATE",
  "version": 1,
  "group_id": "base64url-encoded-32-byte-group-id",
  "creator_device_id": "base64url-encoded-32-byte-creator-id",
  "initial_members": [
    {
      "user_id": "base64url-encoded-32-byte-user-id",
      "device_id": "base64url-encoded-32-byte-device-id",
      "device_public_key": "base64url-encoded-32-byte-device-pubkey"
    }
  ],
  "group_name": "Test Group",
  "timestamp": 1701763206000
}
```

**Canonical CBOR Hex Representation**:
```
D7                                           # Tag(0xD7) - GROUP_CREATE
A6                                           # Map(6)
   64                                        # Text(4) "type"
   6C47524F55505F435245415445                # "GROUP_CREATE"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   68                                        # Text(8) "group_id"
   78 20                                     # Byte(32)
      E1E2E3E4E5E6E7E8E9EAEBECEDEEEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF00
   70                                        # Text(16) "creator_device_id"
   78 20                                     # Byte(32)
      0102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F20
   6E                                        # Text(14) "initial_members"
   81                                        # Array(1)
      A3                                      # Map(3)
         67                                   # Text(7) "user_id"
         78 20                                # Byte(32)
            2122232425262728292A2B2C2D2E2F303132333435363738393A3B3C3D3E3F40
         69                                   # Text(9) "device_id"
         78 20                                # Byte(32)
            4142434445464748494A4B4C4D4E4F505152535455565758595A6162636465
         70                                   # Text(16) "device_public_key"
         78 20                                # Byte(32)
            5152535455565758595A6162636465666768696A6B6C6D6E6F70717273747576
   6A                                        # Text(10) "group_name"
   6A546573742047726F7570                   # "Test Group"
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1258                     # Unsigned(1701763206000)
```

### 3.2 GROUP_JOIN (Type 0x08)

**Message Structure**:
```json
{
  "type": "GROUP_JOIN",
  "version": 1,
  "group_id": "base64url-encoded-32-byte-group-id",
  "joining_device_id": "base64url-encoded-32-byte-joining-device-id",
  "device_public_key": "base64url-encoded-32-byte-device-pubkey",
  "timestamp": 1701763207000
}
```

**Canonical CBOR Hex Representation**:
```
D8                                           # Tag(0xD8) - GROUP_JOIN
A5                                           # Map(5)
   64                                        # Text(4) "type"
   6A47524F55505F4A4F494E                    # "GROUP_JOIN"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   68                                        # Text(8) "group_id"
   78 20                                     # Byte(32)
      6162636465666768696A6B6C6D6E6F707172737475767778797A3031323334353637
   70                                        # Text(16) "joining_device_id"
   78 20                                     # Byte(32)
      38394142434445464748494A4B4C4D4E4F505152535455565758595A6162636465
   70                                        # Text(16) "device_public_key"
   78 20                                     # Byte(32)
      666768696A6B6C6D6E6F707172737475767778797A7B7C7D7E7F8081828384858687
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E12BC                     # Unsigned(1701763207000)
```

### 3.3 GROUP_LEAVE (Type 0x09)

**Message Structure**:
```json
{
  "type": "GROUP_LEAVE",
  "version": 1,
  "group_id": "base64url-encoded-32-byte-group-id",
  "leaving_device_id": "base64url-encoded-32-byte-leaving-device-id",
  "leave_reason": "user_initiated",
  "timestamp": 1701763208000
}
```

**Canonical CBOR Hex Representation**:
```
D9                                           # Tag(0xD9) - GROUP_LEAVE
A5                                           # Map(5)
   64                                        # Text(4) "type"
   6B47524F55505F4C45415645                  # "GROUP_LEAVE"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   68                                        # Text(8) "group_id"
   78 20                                     # Byte(32)
      88898A8B8C8D8E8F909192939495969798999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8
   70                                        # Text(16) "leaving_device_id"
   78 20                                     # Byte(32)
      A9AAABACADAEAFB0B1B2B3B4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3C4C5C6C7C8C9
   6C                                        # Text(12) "leave_reason"
   6E757365725F696E69746961746564           # "user_initiated"
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1320                     # Unsigned(1701763208000)
```

---

## 4. Group Key Distribution Messages

### 4.1 GROUP_KEY_DISTRIBUTION (Type 0x0A)

**Message Structure**:
```json
{
  "type": "GROUP_KEY_DISTRIBUTION",
  "version": 1,
  "group_id": "base64url-encoded-32-byte-group-id",
  "epoch_id": 42,
  "sender_device_id": "base64url-encoded-32-byte-sender-id",
  "group_sender_ck_0": "base64url-encoded-32-byte-sender-chain-key",
  "signature": "base64url-encoded-64-byte-ed25519-signature"
}
```

**Canonical CBOR Hex Representation**:
```
DA                                           # Tag(0xDA) - GROUP_KEY_DISTRIBUTION
A6                                           # Map(6)
   64                                        # Text(4) "type"
   7347524F55505F4B45595F444953545249425554494F4E # "GROUP_KEY_DISTRIBUTION"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   68                                        # Text(8) "group_id"
   78 20                                     # Byte(32)
      CACBCCCDCECFD0D1D2D3D4D5D6D7D8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7E8E9EAEB
   68                                        # Text(8) "epoch_id"
   18 2A                                     # Unsigned(42)
   70                                        # Text(16) "sender_device_id"
   78 20                                     # Byte(32)
      ECEDEEEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF000102030405060708090A0B0C0D
   70                                        # Text(16) "group_sender_ck_0"
   78 20                                     # Byte(32)
      0E0F101112131415161718191A1B1C1D1E1F202122232425262728292A2B2C2D2E2F
   69                                        # Text(9) "signature"
   78 40                                     # Byte(64)
      [64 bytes of Ed25519 signature]
```

---

## 5. Epoch Authenticity Record

### 5.1 EPOCH_AUTHENTICITY_RECORD (Type 0x0B)

**Message Structure**:
```json
{
  "type": "EPOCH_AUTHENTICITY_RECORD",
  "version": 1,
  "group_id": "base64url-encoded-32-byte-group-id",
  "epoch_id": 42,
  "previous_epoch_hash": "base64url-encoded-32-byte-hash",
  "members": [
    {
      "user_id": "base64url-encoded-32-byte-user-id",
      "device_id": "base64url-encoded-32-byte-device-id",
      "device_public_key": "base64url-encoded-32-byte-device-pubkey"
    }
  ],
  "admin_device_ids": ["base64url-encoded-32-byte-admin-id"],
  "timestamp": 1701763209000,
  "reason": "member_added",
  "admin_signatures": [
    {
      "admin_device_id": "base64url-encoded-32-byte-admin-id",
      "signature": "base64url-encoded-64-byte-ed25519-signature"
    }
  ]
}
```

**Canonical CBOR Hex Representation**:
```
DB                                           # Tag(0xDB) - EPOCH_AUTHENTICITY_RECORD
A9                                           # Map(9)
   64                                        # Text(4) "type"
   78 1A                                     # Text(26) "EPOCH_AUTHENTICITY_RECORD"
      45504F43485F41555448454E5449434954595F5245434F5244
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   68                                        # Text(8) "group_id"
   78 20                                     # Byte(32)
      303132333435363738393A3B3C3D3E3F404142434445464748494A4B4C4D4E4F50
   68                                        # Text(8) "epoch_id"
   18 2A                                     # Unsigned(42)
   74                                        # Text(20) "previous_epoch_hash"
   78 20                                     # Byte(32)
      5152535455565758595A6162636465666768696A6B6C6D6E6F7071727374757677
   67                                        # Text(7) "members"
   81                                        # Array(1)
      A3                                      # Map(3)
         67                                   # Text(7) "user_id"
         78 20                                # Byte(32)
            6162636465666768696A6B6C6D6E6F707172737475767778797A3031323334
         69                                   # Text(9) "device_id"
         78 20                                # Byte(32)
            35363738393A3B3C3D3E3F404142434445464748494A4B4C4D4E4F50515253
         70                                   # Text(16) "device_public_key"
         78 20                                # Byte(32)
            5455565758595A6162636465666768696A6B6C6D6E6F707172737475767778
   70                                        # Text(16) "admin_device_ids"
   81                                        # Array(1)
      78 20                                   # Byte(32)
         797A7B7C7D7E7F808182838485868788898A8B8C8D8E8F909192939495969798
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E1384                     # Unsigned(1701763209000)
   66                                        # Text(6) "reason"
   6B6D656D6265725F6164646564               # "member_added"
   70                                        # Text(16) "admin_signatures"
   81                                        # Array(1)
      A2                                      # Map(2)
         70                                   # Text(16) "admin_device_id"
         78 20                                # Byte(32)
            7B7C7D7E7F808182838485868788898A8B8C8D8E8F90919293949596979899
         69                                   # Text(9) "signature"
         78 40                                # Byte(64)
            [64 bytes of Ed25519 signature]
```

---

## 6. Media Messages

### 6.1 MEDIA_KEY_DISTRIBUTION (Type 0x0C)

**Message Structure**:
```json
{
  "type": "MEDIA_KEY_DISTRIBUTION",
  "version": 1,
  "call_id": "base64url-encoded-32-byte-call-id",
  "participant_id": "base64url-encoded-32-byte-participant-id",
  "stream_keys": [
    {
      "stream_id": "audio-main",
      "stream_key": "base64url-encoded-32-byte-stream-key"
    }
  ],
  "media_epoch": 1,
  "timestamp": 1701763210000
}
```

**Canonical CBOR Hex Representation**:
```
DC                                           # Tag(0xDC) - MEDIA_KEY_DISTRIBUTION
A6                                           # Map(6)
   64                                        # Text(4) "type"
   78 15                                     # Text(21) "MEDIA_KEY_DISTRIBUTION"
      4D454449415F4B45595F444953545249425554494F4E
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   67                                        # Text(7) "call_id"
   78 20                                     # Byte(32)
      9A9B9C9D9E9FA0A1A2A3A4A5A6A7A8A9AAABACADAEAFB0B1B2B3B4B5B6B7B8B9BA
   6E                                        # Text(14) "participant_id"
   78 20                                     # Byte(32)
      BBBBBCBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCCCDCECFD0D1D2D3D4D5D6D7D8D9DADB
   6B                                        # Text(11) "stream_keys"
   81                                        # Array(1)
      A2                                      # Map(2)
         69                                   # Text(9) "stream_id"
         6A617564696F2D6D61696E             # "audio-main"
         6A                                   # Text(10) "stream_key"
         78 20                                # Byte(32)
            DCDDEDEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF000102030405060708090A
   6B                                        # Text(11) "media_epoch"
   01                                        # Unsigned(1)
   69                                        # Text(9) "timestamp"
   1A 0000018E 5F5E13E8                     # Unsigned(1701763210000)
```

### 6.2 MEDIA_FRAME (Type 0x0D)

**Message Structure**:
```json
{
  "type": "MEDIA_FRAME",
  "version": 1,
  "header": {
    "call_id": "base64url-encoded-32-byte-call-id",
    "participant_id": "base64url-encoded-32-byte-participant-id",
    "stream_id": "audio-main",
    "frame_sequence": 15,
    "media_epoch": 1,
    "timestamp": 1701763211000,
    "payload_type": 1
  },
  "ciphertext": "base64url-encoded-encrypted-payload",
  "auth_tag": "base64url-encoded-16-byte-auth-tag",
  "iv": "base64url-encoded-12-byte-iv"
}
```

**Canonical CBOR Hex Representation**:
```
DD                                           # Tag(0xDD) - MEDIA_FRAME
A5                                           # Map(5)
   64                                        # Text(4) "type"
   6A4D454449415F4652414D45                  # "MEDIA_FRAME"
   67                                        # Text(7) "version"
   01                                        # Unsigned(1)
   66                                        # Text(6) "header"
   A8                                        # Map(8)
      67                                   # Text(7) "call_id"
      78 20                                # Byte(32)
         EDEEEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF000102030405060708090A0B0C0D
      6E                                   # Text(14) "participant_id"
      78 20                                # Byte(32)
         0E0F101112131415161718191A1B1C1D1E1F202122232425262728292A2B2C2D
      69                                   # Text(9) "stream_id"
      6A617564696F2D6D61696E             # "audio-main"
      6D                                   # Text(13) "frame_sequence"
      0F                                   # Unsigned(15)
      6B                                   # Text(11) "media_epoch"
      01                                   # Unsigned(1)
      69                                   # Text(9) "timestamp"
      1A 0000018E 5F5E144C              # Unsigned(1701763211000)
      6C                                   # Text(12) "payload_type"
      01                                   # Unsigned(1)
   6A                                        # Text(10) "ciphertext"
   78 40                                     # Byte(64)
      [64 bytes of encrypted payload]
   68                                        # Text(8) "auth_tag"
   78 10                                     # Byte(16)
      [16 bytes of authentication tag]
   62                                        # Text(2) "iv"
   78 0C                                     # Byte(12)
      [12 bytes of initialization vector]
```

---

## Validation Procedures

### CBOR Canonicalization Validation

To validate canonical CBOR encoding:

1. **Integer Encoding**: Verify smallest possible encoding is used
2. **Map Key Ordering**: Verify keys are sorted by length then lexicographically
3. **Tag Usage**: Verify semantic tags are correctly applied
4. **Byte String Encoding**: Verify definite-length encoding is used

### Cross-Platform Test Vectors

Implementations should validate against these test vectors:

```javascript
// JavaScript/Node.js example
const cbor = require('cbor');

async function validateCBOR(messageType, expectedHex, testData) {
  // Encode test data
  const encoded = cbor.encodeCanonical(testData);
  
  // Compare with expected hex
  const actualHex = encoded.toString('hex');
  if (actualHex !== expectedHex.toLowerCase()) {
    throw new Error(`CBOR encoding mismatch for ${messageType}`);
  }
  
  // Decode and verify structure
  const decoded = await cbor.decodeFirst(encoded);
  if (!deepEqual(decoded, testData)) {
    throw new Error(`CBOR round-trip failed for ${messageType}`);
  }
  
  console.log(`✓ ${messageType} CBOR validation passed`);
}
```

### Test Vector Execution

Run all test vectors:

```bash
# Python example
python3 validate_cbor.py --all-vectors

# Expected output
✓ HANDSHAKE_INIT CBOR validation passed
✓ HANDSHAKE_RESPONSE CBOR validation passed
✓ HANDSHAKE_COMPLETE CBOR validation passed
✓ DR_BACKUP CBOR validation passed
✓ DR_RESTORE CBOR validation passed
✓ DR_RESET CBOR validation passed
✓ GROUP_CREATE CBOR validation passed
✓ GROUP_JOIN CBOR validation passed
✓ GROUP_LEAVE CBOR validation passed
✓ GROUP_KEY_DISTRIBUTION CBOR validation passed
✓ EPOCH_AUTHENTICITY_RECORD CBOR validation passed
✓ MEDIA_KEY_DISTRIBUTION CBOR validation passed
✓ MEDIA_FRAME CBOR validation passed
```

---

## Implementation Notes

1. **Deterministic Encoding**: All implementations must produce identical byte sequences for identical logical messages
2. **Tag Preservation**: Semantic tags must be preserved during encoding/decoding
3. **Binary Data**: All binary data must be base64url-encoded in JSON representation
4. **Timestamp Format**: Unix timestamps in milliseconds as unsigned integers
5. **Version Handling**: All messages include version field for backward compatibility

---

*This document provides the foundation for FoxWhisper v0.9 conformance testing. Implementations must pass all CBOR encoding validation tests to be considered compliant.*